<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Essays — Michael C. Barros</title>

  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=EB+Garamond:wght@500;600&family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="./style.css">

  <style>
    /* Scoped, light upgrades that won’t fight your style.css */
    :root{
      --ink:#111827; --muted:#6b7280; --ring:rgba(15,118,110,.25); --chip:#eef2ff; --chip-ink:#3730a3;
    }
    .page .wrap{max-width:1100px}
    .hero--compact { padding: 1.25rem 0 0.5rem; }
    .muted{color:var(--muted)}
    .section{margin: 1.75rem 0}
    .section-head{display:flex;align-items:baseline;justify-content:space-between;gap:.75rem}
    .grid{display:grid;gap:1rem}
    .grid-3{grid-template-columns:repeat(auto-fill,minmax(260px,1fr))}
    .card{background:#fff;border-radius:.85rem;padding:1rem;box-shadow:0 1px 0 rgba(0,0,0,.04),0 8px 18px rgba(0,0,0,.04);transition:transform .15s ease, box-shadow .15s ease}
    .card:hover{transform:translateY(-2px);box-shadow:0 10px 22px rgba(0,0,0,.08)}
    .card h3{margin:.25rem 0 .35rem;font-size:1.1rem;line-height:1.25}
    .meta-row{display:flex;gap:.5rem;align-items:center;flex-wrap:wrap;color:var(--muted);font-size:.85rem;margin:.25rem 0 .5rem}
    .chips{display:flex;gap:.35rem;flex-wrap:wrap}
    .chip{background:var(--chip);color:var(--chip-ink);padding:.18rem .5rem;border-radius:.6rem;font-size:.72rem}
    .card .actions{margin-top:.6rem;display:flex;gap:.5rem;flex-wrap:wrap}
    .btn-sm{display:inline-block;padding:.45rem .7rem;border-radius:.6rem;background:#111827;color:#fff;text-decoration:none;font-weight:600;font-size:.9rem}
    .btn-ghost{background:transparent;color:#111827;border:2px solid #111827}
    .filters{display:flex;gap:.4rem;flex-wrap:wrap;margin:.4rem 0 1rem}
    .filter-btn{padding:.35rem .6rem;border-radius:.6rem;border:1px solid #e5e7eb;background:#fff;cursor:pointer;font-size:.85rem}
    .filter-btn.active{border-color:#0f766e;box-shadow:0 0 0 3px var(--ring)}
    .toolbar{display:flex;gap:.6rem;flex-wrap:wrap;align-items:center;margin:.5rem 0 1rem}
    .toolbar input[type="search"]{flex:1 1 280px;padding:.55rem .7rem;border:1px solid #e5e7eb;border-radius:.6rem}
    .empty{padding:1rem;border:1px dashed #e5e7eb;border-radius:.75rem;background:#fafafa}

    /* Modal */
    .modal{position:fixed;inset:0;background:rgba(0,0,0,.55);display:none}
    .modal[aria-hidden="false"]{display:block}
    .modal .inner{position:relative;max-width:850px;margin:4vh auto;background:#fff;border-radius:1rem;box-shadow:0 15px 35px rgba(0,0,0,.25);padding:1.25rem}
    .modal .inner h1{margin:.4rem 0 0.35rem}
    .modal .meta{color:var(--muted);font-size:.9rem}
    .modal .divider{height:1px;background:#e5e7eb;margin:1rem 0}
    #reader-content p{line-height:1.7}
    #close-reader, #close-reader-bottom{text-decoration:none}
  </style>
</head>

<body class="page">
  <header class="site-header">
    <a class="logo" href="./index.html">Michael C. Barros</a>
    <nav class="nav">
      <a href="./essays.html" class="active">Essays</a>
      <a href="./books.html">Books</a>
      <a href="./media.html">Media</a>
      <a href="./contact.html">Contact</a>
    </nav>
  </header>

  <main class="wrap">
    <section class="hero hero--compact">
      <h1>Essays</h1>
      <p class="muted">Writing on religion, imagination, and popular culture.</p>
    </section>

    <!-- Substack feed -->
    <section class="section">
      <div class="section-head">
        <h2>From Substack</h2>
        <a class="muted" id="substack-view-all" target="_blank" rel="noopener">Open Substack →</a>
      </div>
      <div id="substack-feed" class="grid grid-3"></div>
    </section>

    <div class="divider"></div>

    <!-- Archive with filters + search -->
    <section class="section">
      <div class="section-head">
        <h2>Archive</h2>
        <small class="muted">Filter or search</small>
      </div>

      <div class="toolbar">
        <div id="filters" class="filters" role="group" aria-label="Filters"></div>
        <input id="search" type="search" placeholder="Search title, tags, or summary…" aria-label="Search essays">
      </div>

      <div id="essays-grid" class="grid grid-3"></div>
      <div id="empty" class="empty" style="display:none">No essays match your filters.</div>
    </section>
  </main>

  <!-- Reader modal -->
  <div id="reader-modal" class="modal" aria-hidden="true">
    <div class="inner">
      <p><a href="#" id="close-reader">← Back to Essays</a></p>
      <div id="reader-meta" class="meta"></div>
      <h1 id="reader-title"></h1>
      <p id="reader-thesis" class="muted" style="font-style:italic"></p>
      <div class="divider"></div>
      <article id="reader-content"></article>
      <div class="divider"></div>
      <p><a href="#" id="close-reader-bottom">Close</a></p>
    </div>
  </div>

  <!-- Optional structured data (if present, we'll use it) -->
  <script defer src="./js/data/data.js"></script>

  <script>
    // ---------- Utilities ----------
    const el = (sel) => document.querySelector(sel);
    const els = (sel) => Array.from(document.querySelectorAll(sel));
    const slugify = s => (s||'').toLowerCase().trim()
      .replace(/[^a-z0-9\s-]/g,'')
      .replace(/\s+/g,'-')
      .replace(/-+/g,'-');

    const fmtDate = iso => {
      try { return new Date(iso).toISOString().slice(0,10); } catch { return ""; }
    };

    const contains = (hay, q) => (hay||"").toLowerCase().includes(q);

    // ---------- Data ----------
    function getData(){
      const DATA = (window.SITE_DATA || window.SITE || {});
      const substack = DATA.substack || {
        url: "https://substack.com/@michaelcbarros",
        posts: []
      };
      // essays: normalize shape
      let essays = Array.isArray(DATA.essays) ? DATA.essays.slice() : [];
      essays = essays.map(e => ({
          title: e.title || "Untitled",
          slug: e.slug || slugify(e.title || ""),
          date: e.date || e.published_at || "",
          summary: e.summary || e.thesis || e.excerpt || "",
          content: e.content || "",
          url: e.url || null, // optional external
          tags: Array.isArray(e.tags) ? e.tags : (e.tags ? String(e.tags).split(',').map(t=>t.trim()) : []),
          featured: !!e.featured
      }));
      // Newest first
      essays.sort((a,b)=> (b.date || "").localeCompare(a.date || ""));
      return {substack, essays};
    }

    // ---------- Substack feed ----------
    function renderSubstack(substack){
      const wrap = el("#substack-feed");
      const link = el("#substack-view-all");
      if (link && substack.url) link.href = substack.url;

      const posts = (substack.posts || []).slice(0,3);
      if (!wrap) return;

      if (!posts.length){
        wrap.innerHTML = `
          <div class="empty">Add Substack posts in <code>window.SITE_DATA.substack.posts</code> (title, url, date, summary) to feature them here.</div>`;
        return;
      }

      wrap.innerHTML = "";
      posts.forEach(p=>{
        const card = document.createElement("article");
        card.className = "card";
        card.innerHTML = `
          <h3><a href="${p.url}" target="_blank" rel="noopener">${p.title || "Untitled"}</a></h3>
          <div class="meta-row">
            ${p.date ? `<time datetime="${p.date}">${fmtDate(p.date)}</time>` : ""}
            <span>Substack</span>
          </div>
          <p class="muted">${(p.summary || "").toString().substring(0,160)}</p>
          <div class="actions">
            <a class="btn-sm" href="${p.url}" target="_blank" rel="noopener">Read on Substack →</a>
          </div>
        `;
        wrap.appendChild(card);
      });
    }

    // ---------- Filters & Search ----------
    function buildFilters(essays){
      const set = new Set();
      essays.forEach(e => e.tags.forEach(t => t && set.add(t)));
      const tags = Array.from(set).sort((a,b)=>a.localeCompare(b));

      const filters = el("#filters");
      if (!filters) return {active:"All"};

      const makeBtn = (name, active=false) => {
        const b = document.createElement("button");
        b.type = "button";
        b.className = "filter-btn" + (active ? " active" : "");
        b.dataset.tag = name;
        b.textContent = name;
        return b;
      };

      filters.innerHTML = "";
      filters.appendChild(makeBtn("All", true));
      tags.forEach(t => filters.appendChild(makeBtn(t, false)));

      return {active:"All"};
    }

    // ---------- Archive grid ----------
    function renderGrid(essays, {tag="All", q=""} = {}){
      const grid = el("#essays-grid");
      const empty = el("#empty");
      if (!grid) return;

      const ql = q.trim().toLowerCase();
      const filtered = essays.filter(e => {
        const inTag = tag==="All" || e.tags.includes(tag);
        const inSearch = !ql || contains(e.title.toLowerCase(), ql) || contains(e.summary.toLowerCase(), ql) || e.tags.join(" ").toLowerCase().includes(ql);
        return inTag && inSearch;
      });

      if (!filtered.length){
        grid.innerHTML = "";
        if (empty) empty.style.display = "block";
        return;
      } else if (empty){ empty.style.display = "none"; }

      grid.innerHTML = "";
      filtered.forEach(e=>{
        const card = document.createElement("article");
        card.className = "card";
        const tagChips = e.tags.map(t=>`<span class="chip">${t}</span>`).join("");
        card.innerHTML = `
          <h3><a href="${e.url ? e.url : '#'}" data-slug="${e.slug}" class="${e.url ? '' : 'open-reader'}">${e.title}</a></h3>
          <div class="meta-row">
            ${e.date ? `<time datetime="${e.date}">${fmtDate(e.date)}</time>` : ""}
            ${e.tags.length ? `<span class="chips">${tagChips}</span>` : ""}
          </div>
          <p class="muted">${e.summary}</p>
          <div class="actions">
            ${e.url ? `<a class="btn-sm" href="${e.url}" target="_blank" rel="noopener">Open →</a>`
                     : `<a class="btn-sm" href="#essay=${encodeURIComponent(e.slug)}">Read →</a>`}
            <a class="btn-sm btn-ghost" href="./index.html">Home</a>
          </div>
        `;
        grid.appendChild(card);
      });

      // attach open-reader click handlers
      grid.querySelectorAll(".open-reader").forEach(a=>{
        a.addEventListener("click",(ev)=>{
          ev.preventDefault();
          const slug = a.getAttribute("data-slug");
          if (slug) openReaderBySlug(slug, true);
        });
      });
    }

    // ---------- Reader (modal) ----------
    const modal = el("#reader-modal");
    const titleEl = el("#reader-title");
    const thesisEl = el("#reader-thesis");
    const metaEl = el("#reader-meta");
    const contentEl = el("#reader-content");

    function openReaderBySlug(slug, pushHash=false){
      const {essays} = getData();
      const item = essays.find(e => e.slug === slug);
      if (!item){ return; }

      titleEl.textContent = item.title;
      thesisEl.textContent = item.summary || "";
      metaEl.innerHTML = `${item.date ? `<time datetime="${item.date}">${fmtDate(item.date)}</time>` : ""} ${item.tags && item.tags.length ? " · " + item.tags.join(", ") : ""}`;

      // We allow HTML in content. If your data is Markdown, pre-render it in data.js or keep it simple paragraph-wise.
      contentEl.innerHTML = item.content ? item.content : `<p>Full text coming soon.</p>`;

      modal.setAttribute("aria-hidden","false");
      document.body.style.overflow = "hidden";

      if (pushHash){
        location.hash = `essay=${encodeURIComponent(slug)}`;
      }
    }

    function closeReader(){
      modal.setAttribute("aria-hidden","true");
      document.body.style.overflow = "";
      // Clear hash if it matches our pattern
      if (location.hash.startsWith("#essay=")) history.replaceState(null,"", location.pathname + location.search);
    }

    el("#close-reader")?.addEventListener("click", (e)=>{ e.preventDefault(); closeReader(); });
    el("#close-reader-bottom")?.addEventListener("click", (e)=>{ e.preventDefault(); closeReader(); });
    modal?.addEventListener("click", (e)=>{ if (e.target === modal) closeReader(); });
    document.addEventListener("keydown", (e)=>{ if (e.key === "Escape") closeReader(); });

    function hydrateFromHash(){
      if (!location.hash) return;
      const m = location.hash.match(/^#?essay=([^&]+)/);
      if (m && m[1]) openReaderBySlug(decodeURIComponent(m[1]));
    }

    // ---------- Boot ----------
    function boot(){
      const {substack, essays} = getData();

      renderSubstack(substack);

      const state = buildFilters(essays); // creates buttons
      renderGrid(essays, {tag:state.active, q:""});

      // Filter behavior
      el("#filters")?.addEventListener("click",(ev)=>{
        const b = ev.target.closest(".filter-btn");
        if (!b) return;
        els(".filter-btn").forEach(x=>x.classList.remove("active"));
        b.classList.add("active");
        const tag = b.dataset.tag || "All";
        renderGrid(essays, {tag, q: el("#search")?.value || ""});
      });

      // Search behavior (debounced)
      let t=null;
      el("#search")?.addEventListener("input",(e)=>{
        clearTimeout(t);
        const q = e.target.value || "";
        const activeBtn = el(".filter-btn.active");
        const tag = activeBtn ? activeBtn.dataset.tag : "All";
        t = setTimeout(()=> renderGrid(essays, {tag, q}), 120);
      });

      // Hash deep link
      hydrateFromHash();
      window.addEventListener("hashchange", hydrateFromHash);
    }

    // Wait a tick to allow data.js (if present) to load
    window.addEventListener("DOMContentLoaded", ()=> setTimeout(boot, 30));
  </script>
</body>
</html>
